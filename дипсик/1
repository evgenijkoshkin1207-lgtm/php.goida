<?php
/*
 * РАБОЧЕЕ PHP ПРИЛОЖЕНИЕ
 * Полнофункциональная система управления пользователями
 * С базой данных, аутентификацией и интерфейсом
 */

declare(strict_types=1);

// Настройки
error_reporting(E_ALL);
ini_set('display_errors', '1');
session_start();

// Константы
define('APP_NAME', 'User Management System');
define('APP_VERSION', '1.0');
define('BASE_URL', 'http://' . $_SERVER['HTTP_HOST'] . dirname($_SERVER['PHP_SELF']));
define('DB_FILE', __DIR__ . '/database.sqlite');

// Класс базы данных
class Database
{
    private static ?\PDO $instance = null;
    
    public static function getInstance(): \PDO
    {
        if (self::$instance === null) {
            try {
                self::$instance = new \PDO('sqlite:' . DB_FILE);
                self::$instance->setAttribute(\PDO::ATTR_ERRMODE, \PDO::ERRMODE_EXCEPTION);
                self::$instance->setAttribute(\PDO::ATTR_DEFAULT_FETCH_MODE, \PDO::FETCH_ASSOC);
                
                // Создание таблиц если их нет
                self::createTables();
                
            } catch (\PDOException $e) {
                die('Database error: ' . $e->getMessage());
            }
        }
        
        return self::$instance;
    }
    
    private static function createTables(): void
    {
        $sql = "
            CREATE TABLE IF NOT EXISTS users (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                username VARCHAR(50) UNIQUE NOT NULL,
                email VARCHAR(100) UNIQUE NOT NULL,
                password_hash VARCHAR(255) NOT NULL,
                full_name VARCHAR(100),
                birth_date DATE,
                created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                is_active BOOLEAN DEFAULT 1,
                last_login DATETIME
            );
            
            CREATE TABLE IF NOT EXISTS products (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name VARCHAR(100) NOT NULL,
                description TEXT,
                price DECIMAL(10,2) NOT NULL,
                category VARCHAR(50),
                stock INTEGER DEFAULT 0,
                created_at DATETIME DEFAULT CURRENT_TIMESTAMP
            );
            
            CREATE TABLE IF NOT EXISTS orders (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER,
                total_amount DECIMAL(10,2) NOT NULL,
                status VARCHAR(20) DEFAULT 'pending',
                created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users(id)
            );
            
            CREATE TABLE IF NOT EXISTS sessions (
                id VARCHAR(128) PRIMARY KEY,
                user_id INTEGER,
                data TEXT,
                created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                last_activity DATETIME DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users(id)
            );
        ";
        
        self::getInstance()->exec($sql);
        
        // Добавляем тестовые данные если таблицы пустые
        self::seedData();
    }
    
    private static function seedData(): void
    {
        // Проверяем есть ли пользователи
        $stmt = self::getInstance()->query("SELECT COUNT(*) as count FROM users");
        $result = $stmt->fetch();
        
        if ($result['count'] == 0) {
            // Добавляем тестовых пользователей
            $users = [
                ['admin', 'admin@example.com', password_hash('admin123', PASSWORD_DEFAULT), 'Администратор Системы'],
                ['user1', 'user1@example.com', password_hash('user123', PASSWORD_DEFAULT), 'Иван Петров'],
                ['user2', 'user2@example.com', password_hash('user123', PASSWORD_DEFAULT), 'Мария Сидорова']
            ];
            
            $stmt = self::getInstance()->prepare("
                INSERT INTO users (username, email, password_hash, full_name) 
                VALUES (?, ?, ?, ?)
            ");
            
            foreach ($users as $user) {
                $stmt->execute($user);
            }
            
            // Добавляем тестовые товары
            $products = [
                ['Ноутбук Dell XPS 13', 'Мощный ультрабук с экраном 13 дюймов', 129999.99, 'Электроника', 10],
                ['iPhone 15 Pro', 'Смартфон Apple с камерой 48 МП', 99999.99, 'Электроника', 25],
                ['Книга "PHP 8.0"', 'Руководство по PHP 8.0', 2999.99, 'Книги', 50],
                ['Кофеварка DeLonghi', 'Автоматическая кофемашина', 45999.99, 'Бытовая техника', 8],
                ['Футболка хлопковая', 'Мужская футболка из 100% хлопка', 1999.99, 'Одежда', 100],
                ['Наушники Sony WH-1000XM4', 'Беспроводные наушники с шумоподавлением', 29999.99, 'Электроника', 15],
                ['Мышь Logitech MX Master 3', 'Беспроводная мышь для профессионалов', 8999.99, 'Компьютерные аксессуары', 30],
                ['Монитор Samsung 27"', '4K монитор с IPS матрицей', 34999.99, 'Электроника', 12],
                ['Стул офисный', 'Эргономичный офисный стул', 15999.99, 'Мебель', 5],
                ['Внешний SSD 1TB', 'Высокоскоростной SSD диск', 7999.99, 'Компьютерные аксессуары', 20]
            ];
            
            $stmt = self::getInstance()->prepare("
                INSERT INTO products (name, description, price, category, stock) 
                VALUES (?, ?, ?, ?, ?)
            ");
            
            foreach ($products as $product) {
                $stmt->execute($product);
            }
            
            // Добавляем тестовые заказы
            $orders = [
                [2, 129999.99, 'completed'],
                [2, 2999.99, 'processing'],
                [3, 45999.99, 'pending']
            ];
            
            $stmt = self::getInstance()->prepare("
                INSERT INTO orders (user_id, total_amount, status) 
                VALUES (?, ?, ?)
            ");
            
            foreach ($orders as $order) {
                $stmt->execute($order);
            }
        }
    }
}

// Класс пользователя
class User
{
    private ?int $id = null;
    private string $username;
    private string $email;
    private string $passwordHash;
    private ?string $fullName = null;
    private ?string $birthDate = null;
    private string $createdAt;
    private ?string $updatedAt = null;
    private bool $isActive = true;
    private ?string $lastLogin = null;
    
    public static function register(array $data): bool
    {
        $db = Database::getInstance();
        
        // Проверка существования пользователя
        $stmt = $db->prepare("SELECT id FROM users WHERE username = ? OR email = ?");
        $stmt->execute([$data['username'], $data['email']]);
        
        if ($stmt->fetch()) {
            $_SESSION['error'] = 'Пользователь с таким именем или email уже существует';
            return false;
        }
        
        // Хэширование пароля
        $passwordHash = password_hash($data['password'], PASSWORD_DEFAULT);
        
        // Вставка пользователя
        $stmt = $db->prepare("
            INSERT INTO users (username, email, password_hash, full_name, birth_date) 
            VALUES (?, ?, ?, ?, ?)
        ");
        
        try {
            $stmt->execute([
                $data['username'],
                $data['email'],
                $passwordHash,
                $data['full_name'] ?? null,
                $data['birth_date'] ?? null
            ]);
            
            $_SESSION['success'] = 'Регистрация успешна! Теперь вы можете войти.';
            return true;
            
        } catch (\PDOException $e) {
            $_SESSION['error'] = 'Ошибка регистрации: ' . $e->getMessage();
            return false;
        }
    }
    
    public static function login(string $username, string $password): ?User
    {
        $db = Database::getInstance();
        
        $stmt = $db->prepare("
            SELECT * FROM users 
            WHERE (username = ? OR email = ?) AND is_active = 1
        ");
        
        $stmt->execute([$username, $username]);
        $userData = $stmt->fetch();
        
        if (!$userData || !password_verify($password, $userData['password_hash'])) {
            $_SESSION['error'] = 'Неверное имя пользователя или пароль';
            return null;
        }
        
        // Обновляем время последнего входа
        $stmt = $db->prepare("UPDATE users SET last_login = CURRENT_TIMESTAMP WHERE id = ?");
        $stmt->execute([$userData['id']]);
        
        // Создаем объект пользователя
        $user = new self();
        $user->id = (int) $userData['id'];
        $user->username = $userData['username'];
        $user->email = $userData['email'];
        $user->passwordHash = $userData['password_hash'];
        $user->fullName = $userData['full_name'];
        $user->birthDate = $userData['birth_date'];
        $user->createdAt = $userData['created_at'];
        $user->updatedAt = $userData['updated_at'];
        $user->isActive = (bool) $userData['is_active'];
        $user->lastLogin = $userData['last_login'];
        
        // Сохраняем в сессию
        $_SESSION['user_id'] = $user->id;
        $_SESSION['username'] = $user->username;
        $_SESSION['email'] = $user->email;
        $_SESSION['full_name'] = $user->fullName;
        $_SESSION['is_logged_in'] = true;
        
        $_SESSION['success'] = 'Добро пожаловать, ' . ($user->fullName ?: $user->username) . '!';
        
        return $user;
    }
    
    public static function logout(): void
    {
        $_SESSION = [];
        session_destroy();
        session_start();
        $_SESSION['success'] = 'Вы успешно вышли из системы';
    }
    
    public static function isLoggedIn(): bool
    {
        return isset($_SESSION['is_logged_in']) && $_SESSION['is_logged_in'] === true;
    }
    
    public static function getCurrentUser(): ?User
    {
        if (!self::isLoggedIn()) {
            return null;
        }
        
        $db = Database::getInstance();
        $stmt = $db->prepare("SELECT * FROM users WHERE id = ?");
        $stmt->execute([$_SESSION['user_id']]);
        $userData = $stmt->fetch();
        
        if (!$userData) {
            return null;
        }
        
        $user = new self();
        $user->id = (int) $userData['id'];
        $user->username = $userData['username'];
        $user->email = $userData['email'];
        $user->passwordHash = $userData['password_hash'];
        $user->fullName = $userData['full_name'];
        $user->birthDate = $userData['birth_date'];
        $user->createdAt = $userData['created_at'];
        $user->updatedAt = $userData['updated_at'];
        $user->isActive = (bool) $userData['is_active'];
        $user->lastLogin = $userData['last_login'];
        
        return $user;
    }
    
    public static function getAllUsers(int $limit = 50): array
    {
        $db = Database::getInstance();
        $stmt = $db->query("
            SELECT id, username, email, full_name, birth_date, 
                   created_at, last_login, is_active 
            FROM users 
            ORDER BY created_at DESC 
            LIMIT $limit
        ");
        
        return $stmt->fetchAll();
    }
    
    public function updateProfile(array $data): bool
    {
        $db = Database::getInstance();
        
        $fields = [];
        $params = [];
        
        if (!empty($data['full_name'])) {
            $fields[] = 'full_name = ?';
            $params[] = $data['full_name'];
        }
        
        if (!empty($data['birth_date'])) {
            $fields[] = 'birth_date = ?';
            $params[] = $data['birth_date'];
        }
        
        if (!empty($data['password'])) {
            $fields[] = 'password_hash = ?';
            $params[] = password_hash($data['password'], PASSWORD_DEFAULT);
        }
        
        if (empty($fields)) {
            return true;
        }
        
        $fields[] = 'updated_at = CURRENT_TIMESTAMP';
        $params[] = $this->id;
        
        $sql = "UPDATE users SET " . implode(', ', $fields) . " WHERE id = ?";
        $stmt = $db->prepare($sql);
        
        try {
            $stmt->execute($params);
            
            // Обновляем данные в сессии
            if (!empty($data['full_name'])) {
                $_SESSION['full_name'] = $data['full_name'];
            }
            
            $_SESSION['success'] = 'Профиль успешно обновлен';
            return true;
            
        } catch (\PDOException $e) {
            $_SESSION['error'] = 'Ошибка обновления профиля: ' . $e->getMessage();
            return false;
        }
    }
    
    // Геттеры
    public function getId(): ?int { return $this->id; }
    public function getUsername(): string { return $this->username; }
    public function getEmail(): string { return $this->email; }
    public function getFullName(): ?string { return $this->fullName; }
    public function getBirthDate(): ?string { return $this->birthDate; }
    public function getCreatedAt(): string { return $this->createdAt; }
    public function getLastLogin(): ?string { return $this->lastLogin; }
    public function getAge(): ?int
    {
        if (!$this->birthDate) {
            return null;
        }
        
        $birthDate = new DateTime($this->birthDate);
        $today = new DateTime();
        $age = $today->diff($birthDate);
        
        return $age->y;
    }
}

// Класс товаров
class Product
{
    public static function getAllProducts(string $category = null, int $limit = 100): array
    {
        $db = Database::getInstance();
        
        $sql = "SELECT * FROM products";
        $params = [];
        
        if ($category) {
            $sql .= " WHERE category = ?";
            $params[] = $category;
        }
        
        $sql .= " ORDER BY created_at DESC LIMIT $limit";
        
        $stmt = $db->prepare($sql);
        $stmt->execute($params);
        
        return $stmt->fetchAll();
    }
    
    public static function getProduct(int $id): ?array
    {
        $db = Database::getInstance();
        $stmt = $db->prepare("SELECT * FROM products WHERE id = ?");
        $stmt->execute([$id]);
        
        return $stmt->fetch() ?: null;
    }
    
    public static function getCategories(): array
    {
        $db = Database::getInstance();
        $stmt = $db->query("SELECT DISTINCT category FROM products WHERE category IS NOT NULL ORDER BY category");
        
        return $stmt->fetchAll(\PDO::FETCH_COLUMN);
    }
    
    public static function searchProducts(string $query, int $limit = 20): array
    {
        $db = Database::getInstance();
        $stmt = $db->prepare("
            SELECT * FROM products 
            WHERE name LIKE ? OR description LIKE ? OR category LIKE ?
            ORDER BY created_at DESC 
            LIMIT ?
        ");
        
        $searchTerm = '%' . $query . '%';
        $stmt->execute([$searchTerm, $searchTerm, $searchTerm, $limit]);
        
        return $stmt->fetchAll();
    }
    
    public static function addProduct(array $data): bool
    {
        $db = Database::getInstance();
        
        $stmt = $db->prepare("
            INSERT INTO products (name, description, price, category, stock) 
            VALUES (?, ?, ?, ?, ?)
        ");
        
        try {
            $stmt->execute([
                $data['name'],
                $data['description'] ?? '',
                $data['price'],
                $data['category'] ?? null,
                $data['stock'] ?? 0
            ]);
            
            $_SESSION['success'] = 'Товар успешно добавлен';
            return true;
            
        } catch (\PDOException $e) {
            $_SESSION['error'] = 'Ошибка добавления товара: ' . $e->getMessage();
            return false;
        }
    }
}

// Класс заказов
class Order
{
    public static function createOrder(int $userId, array $items): ?int
    {
        $db = Database::getInstance();
        
        try {
            $db->beginTransaction();
            
            // Рассчитываем общую сумму
            $totalAmount = 0;
            foreach ($items as $item) {
                $product = Product::getProduct($item['product_id']);
                if (!$product || $product['stock'] < $item['quantity']) {
                    throw new \Exception('Товар недоступен или недостаточно на складе');
                }
                $totalAmount += $product['price'] * $item['quantity'];
            }
            
            // Создаем заказ
            $stmt = $db->prepare("
                INSERT INTO orders (user_id, total_amount, status) 
                VALUES (?, ?, 'pending')
            ");
            $stmt->execute([$userId, $totalAmount]);
            $orderId = $db->lastInsertId();
            
            // Обновляем остатки на складе
            foreach ($items as $item) {
                $stmt = $db->prepare("UPDATE products SET stock = stock - ? WHERE id = ?");
                $stmt->execute([$item['quantity'], $item['product_id']]);
            }
            
            $db->commit();
            
            $_SESSION['success'] = 'Заказ #' . $orderId . ' успешно создан на сумму ' . number_format($totalAmount, 2) . ' руб.';
            return (int) $orderId;
            
        } catch (\Exception $e) {
            $db->rollBack();
            $_SESSION['error'] = 'Ошибка создания заказа: ' . $e->getMessage();
            return null;
        }
    }
    
    public static function getUserOrders(int $userId): array
    {
        $db = Database::getInstance();
        $stmt = $db->prepare("
            SELECT * FROM orders 
            WHERE user_id = ? 
            ORDER BY created_at DESC
        ");
        $stmt->execute([$userId]);
        
        return $stmt->fetchAll();
    }
    
    public static function getAllOrders(int $limit = 50): array
    {
        $db = Database::getInstance();
        $stmt = $db->query("
            SELECT o.*, u.username, u.email 
            FROM orders o 
            LEFT JOIN users u ON o.user_id = u.id 
            ORDER BY o.created_at DESC 
            LIMIT $limit
        ");
        
        return $stmt->fetchAll();
    }
    
    public static function updateOrderStatus(int $orderId, string $status): bool
    {
        $db = Database::getInstance();
        $stmt = $db->prepare("UPDATE orders SET status = ? WHERE id = ?");
        
        try {
            $stmt->execute([$status, $orderId]);
            return true;
        } catch (\PDOException $e) {
            $_SESSION['error'] = 'Ошибка обновления заказа: ' . $e->getMessage();
            return false;
        }
    }
}

// Класс статистики
class Statistics
{
    public static function getDashboardStats(): array
    {
        $db = Database::getInstance();
        
        $stats = [];
        
        // Количество пользователей
        $stmt = $db->query("SELECT COUNT(*) as count FROM users");
        $stats['total_users'] = $stmt->fetch()['count'];
        
        // Количество активных пользователей
        $stmt = $db->query("SELECT COUNT(*) as count FROM users WHERE is_active = 1");
        $stats['active_users'] = $stmt->fetch()['count'];
        
        // Количество товаров
        $stmt = $db->query("SELECT COUNT(*) as count FROM products");
        $stats['total_products'] = $stmt->fetch()['count'];
        
        // Общее количество товаров на складе
        $stmt = $db->query("SELECT SUM(stock) as total FROM products");
        $stats['total_stock'] = $stmt->fetch()['total'] ?? 0;
        
        // Количество заказов
        $stmt = $db->query("SELECT COUNT(*) as count FROM orders");
        $stats['total_orders'] = $stmt->fetch()['count'];
        
        // Общая сумма заказов
        $stmt = $db->query("SELECT SUM(total_amount) as total FROM orders");
        $stats['total_revenue'] = $stmt->fetch()['total'] ?? 0;
        
        // Заказы по статусам
        $stmt = $db->query("
            SELECT status, COUNT(*) as count 
            FROM orders 
            GROUP BY status
        ");
        $stats['orders_by_status'] = $stmt->fetchAll();
        
        // Новые пользователи за последние 7 дней
        $stmt = $db->query("
            SELECT COUNT(*) as count 
            FROM users 
            WHERE DATE(created_at) >= DATE('now', '-7 days')
        ");
        $stats['new_users_7_days'] = $stmt->fetch()['count'];
        
        // Товары по категориям
        $stmt = $db->query("
            SELECT category, COUNT(*) as count, SUM(stock) as stock 
            FROM products 
            WHERE category IS NOT NULL 
            GROUP BY category
        ");
        $stats['products_by_category'] = $stmt->fetchAll();
        
        return $stats;
    }
    
    public static function getRecentActivity(int $limit = 10): array
    {
        $db = Database::getInstance();
        
        $activity = [];
        
        // Последние заказы
        $stmt = $db->query("
            SELECT o.*, u.username 
            FROM orders o 
            LEFT JOIN users u ON o.user_id = u.id 
            ORDER BY o.created_at DESC 
            LIMIT $limit
        ");
        $activity['recent_orders'] = $stmt->fetchAll();
        
        // Последние пользователи
        $stmt = $db->query("
            SELECT id, username, email, created_at 
            FROM users 
            ORDER BY created_at DESC 
            LIMIT $limit
        ");
        $activity['recent_users'] = $stmt->fetchAll();
        
        // Последние товары
        $stmt = $db->query("
            SELECT id, name, price, created_at 
            FROM products 
            ORDER BY created_at DESC 
            LIMIT $limit
        ");
        $activity['recent_products'] = $stmt->fetchAll();
        
        return $activity;
    }
}

// Класс для работы с файлами
class FileManager
{
    public static function uploadFile(array $file, string $targetDir = 'uploads/'): ?string
    {
        if (!is_uploaded_file($file['tmp_name'])) {
            return null;
        }
        
        if (!is_dir($targetDir)) {
            mkdir($targetDir, 0755, true);
        }
        
        $filename = uniqid() . '_' . basename($file['name']);
        $targetPath = $targetDir . $filename;
        
        if (move_uploaded_file($file['tmp_name'], $targetPath)) {
            return $targetPath;
        }
        
        return null;
    }
    
    public static function exportUsersToCSV(): string
    {
        $users = User::getAllUsers();
        $filename = 'users_export_' . date('Y-m-d_H-i-s') . '.csv';
        $filepath = 'exports/' . $filename;
        
        if (!is_dir('exports')) {
            mkdir('exports', 0755, true);
        }
        
        $fp = fopen($filepath, 'w');
        
        // Заголовки
        fputcsv($fp, ['ID', 'Username', 'Email', 'Full Name', 'Birth Date', 'Created At', 'Last Login', 'Active']);
        
        // Данные
        foreach ($users as $user) {
            fputcsv($fp, [
                $user['id'],
                $user['username'],
                $user['email'],
                $user['full_name'],
                $user['birth_date'],
                $user['created_at'],
                $user['last_login'],
                $user['is_active'] ? 'Yes' : 'No'
            ]);
        }
        
        fclose($fp);
        
        return $filepath;
    }
}

// Вспомогательные функции
function displayMessages(): void
{
    if (isset($_SESSION['success'])) {
        echo '<div class="alert alert-success">' . htmlspecialchars($_SESSION['success']) . '</div>';
        unset($_SESSION['success']);
    }
    
    if (isset($_SESSION['error'])) {
        echo '<div class="alert alert-danger">' . htmlspecialchars($_SESSION['error']) . '</div>';
        unset($_SESSION['error']);
    }
    
    if (isset($_SESSION['info'])) {
        echo '<div class="alert alert-info">' . htmlspecialchars($_SESSION['info']) . '</div>';
        unset($_SESSION['info']);
    }
}

function formatDate(string $date): string
{
    if (empty($date)) {
        return 'Не указано';
    }
    
    $timestamp = strtotime($date);
    return date('d.m.Y H:i', $timestamp);
}

function formatPrice(float $price): string
{
    return number_format($price, 2, '.', ' ') . ' руб.';
}

function getCurrentPage(): string
{
    return basename($_SERVER['PHP_SELF']);
}

// Обработка POST запросов
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $action = $_POST['action'] ?? '';
    
    switch ($action) {
        case 'login':
            $username = trim($_POST['username'] ?? '');
            $password = $_POST['password'] ?? '';
            
            if (empty($username) || empty($password)) {
                $_SESSION['error'] = 'Заполните все поля';
            } else {
                User::login($username, $password);
            }
            break;
            
        case 'register':
            $data = [
                'username' => trim($_POST['username'] ?? ''),
                'email' => trim($_POST['email'] ?? ''),
                'password' => $_POST['password'] ?? '',
                'full_name' => trim($_POST['full_name'] ?? ''),
                'birth_date' => $_POST['birth_date'] ?? null
            ];
            
            if (empty($data['username']) || empty($data['email']) || empty($data['password'])) {
                $_SESSION['error'] = 'Заполните обязательные поля';
            } elseif (!filter_var($data['email'], FILTER_VALIDATE_EMAIL)) {
                $_SESSION['error'] = 'Неверный формат email';
            } else {
                User::register($data);
            }
            break;
            
        case 'logout':
            User::logout();
            break;
            
        case 'update_profile':
            $user = User::getCurrentUser();
            if ($user) {
                $data = [
                    'full_name' => trim($_POST['full_name'] ?? ''),
                    'birth_date' => $_POST['birth_date'] ?? null,
                    'password' => $_POST['password'] ?? ''
                ];
                $user->updateProfile($data);
            }
            break;
            
        case 'add_product':
            if (User::isLoggedIn()) {
                $data = [
                    'name' => trim($_POST['name'] ?? ''),
                    'description' => trim($_POST['description'] ?? ''),
                    'price' => (float) ($_POST['price'] ?? 0),
                    'category' => $_POST['category'] ?? null,
                    'stock' => (int) ($_POST['stock'] ?? 0)
                ];
                
                if (empty($data['name']) || $data['price'] <= 0) {
                    $_SESSION['error'] = 'Заполните обязательные поля корректно';
                } else {
                    Product::addProduct($data);
                }
            }
            break;
            
        case 'create_order':
            if (User::isLoggedIn()) {
                $items = json_decode($_POST['items'] ?? '[]', true);
                if (!empty($items)) {
                    Order::createOrder($_SESSION['user_id'], $items);
                }
            }
            break;
            
        case 'update_order_status':
            $orderId = (int) ($_POST['order_id'] ?? 0);
            $status = $_POST['status'] ?? '';
            
            if ($orderId && $status) {
                Order::updateOrderStatus($orderId, $status);
            }
            break;
            
        case 'search':
            $_SESSION['search_query'] = trim($_POST['query'] ?? '');
            break;
    }
    
    // Перенаправление чтобы избежать повторной отправки формы
    header('Location: ' . BASE_URL);
    exit;
}

// Получаем текущего пользователя
$currentUser = User::getCurrentUser();

// Определяем страницу
$page = $_GET['page'] ?? 'home';
$category = $_GET['category'] ?? null;
$searchQuery = $_SESSION['search_query'] ?? null;

// Если был поиск, очищаем запрос после использования
if (isset($_SESSION['search_query'])) {
    unset($_SESSION['search_query']);
}

// Стили и скрипты
$css = "
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 20px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
            overflow: hidden;
        }
        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 30px; 
            text-align: center;
        }
        .header h1 { 
            font-size: 2.5rem; 
            margin-bottom: 10px; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .nav { 
            background: rgba(255,255,255,0.1); 
            padding: 15px; 
            display: flex; 
            justify-content: center; 
            gap: 20px; 
            flex-wrap: wrap;
        }
        .nav a { 
            color: white; 
            text-decoration: none; 
            padding: 10px 20px; 
            border-radius: 25px; 
            transition: all 0.3s; 
            background: rgba(255,255,255,0.2);
        }
        .nav a:hover { 
            background: rgba(255,255,255,0.3); 
            transform: translateY(-2px);
        }
        .main { 
            padding: 30px; 
            min-height: 500px;
        }
        .card { 
            background: white; 
            border-radius: 15px; 
            padding: 25px; 
            margin-bottom: 25px; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.1); 
            border: 1px solid #e0e0e0;
            transition: transform 0.3s;
        }
        .card:hover { 
            transform: translateY(-5px);
        }
        .alert { 
            padding: 15px; 
            border-radius: 10px; 
            margin-bottom: 20px;
        }
        .alert-success { 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb;
        }
        .alert-danger { 
            background: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb;
        }
        .form-group { 
            margin-bottom: 20px;
        }
        label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: bold;
        }
        input, select, textarea { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            font-size: 16px; 
            transition: border-color 0.3s;
        }
        input:focus, select:focus, textarea:focus { 
            border-color: #667eea; 
            outline: none;
        }
        .btn { 
            display: inline-block; 
            padding: 12px 30px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            border: none; 
            border-radius: 25px; 
            cursor: pointer; 
            font-size: 16px; 
            text-decoration: none; 
            transition: all 0.3s;
        }
        .btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        .table { 
            width: 100%; 
            border-collapse: collapse; 
            margin: 20px 0;
        }
        .table th, .table td { 
            padding: 12px; 
            text-align: left; 
            border-bottom: 1px solid #ddd;
        }
        .table th { 
            background: #f8f9fa; 
            font-weight: bold;
        }
        .table tr:hover { 
            background: #f8f9fa;
        }
        .user-info { 
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); 
            color: white; 
            padding: 20px; 
            border-radius: 15px; 
            margin: 20px 0;
        }
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; 
            margin: 20px 0;
        }
        .stat-card { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 20px; 
            border-radius: 15px; 
            text-align: center;
        }
        .stat-value { 
            font-size: 2.5rem; 
            font-weight: bold; 
            margin: 10px 0;
        }
        .product-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
            gap: 20px; 
            margin: 20px 0;
        }
        .product-card { 
            border: 1px solid #ddd; 
            border-radius: 10px; 
            overflow: hidden; 
            transition: all 0.3s;
        }
        .product-card:hover { 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .product-image { 
            height: 200px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: white; 
            font-size: 48px;
        }
        .product-info { 
            padding: 15px;
        }
        .product-price { 
            font-size: 1.5rem; 
            color: #667eea; 
            font-weight: bold; 
            margin: 10px 0;
        }
        .footer { 
            text-align: center; 
            padding: 20px; 
            background: #f8f9fa; 
            color: #666;
        }
    </style>
";

// JavaScript для интерактивности
$js = "
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Анимация появления элементов
            const cards = document.querySelectorAll('.card');
            cards.forEach((card, index) => {
                card.style.animation = 'fadeIn 0.5s ease forwards';
                card.style.animationDelay = (index * 0.1) + 's';
                card.style.opacity = '0';
            });
            
            // Обработка форм
            const forms = document.querySelectorAll('form');
            forms.forEach(form => {
                form.addEventListener('submit', function(e) {
                    const submitBtn = this.querySelector('button[type=\"submit\"]');
                    if (submitBtn) {
                        submitBtn.innerHTML = '<span>Обработка...</span>';
                        submitBtn.disabled = true;
                    }
                });
            });
            
            // Подтверждение действий
            const confirmLinks = document.querySelectorAll('a[data-confirm]');
            confirmLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    if (!confirm(this.dataset.confirm)) {
                        e.preventDefault();
                    }
                });
            });
            
            // Поиск в реальном времени
            const searchInput = document.querySelector('input[type=\"search\"]');
            if (searchInput) {
                searchInput.addEventListener('input', debounce(function() {
                    // Можно добавить AJAX поиск
                }, 300));
            }
        });
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
    
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
";

// Рендерим страницу
ob_start();
?>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?= APP_NAME ?> - <?= ucfirst($page) ?></title>
    <?= $css ?>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><?= APP_NAME ?></h1>
            <p>Версия <?= APP_VERSION ?> | База данных: <?= basename(DB_FILE) ?></p>
            
            <?php if ($currentUser): ?>
                <div class="user-info">
                    <h2>Добро пожаловать, <?= htmlspecialchars($currentUser->getFullName() ?: $currentUser->getUsername()) ?>!</h2>
                    <p>Email: <?= htmlspecialchars($currentUser->getEmail()) ?> | 
                       Дата регистрации: <?= formatDate($currentUser->getCreatedAt()) ?> | 
                       <?php if ($age = $currentUser->getAge()): ?>
                           Возраст: <?= $age ?> лет
                       <?php endif; ?>
                    </p>
                </div>
            <?php endif; ?>
        </div>
        
        <div class="nav">
            <a href="?page=home">Главная</a>
            <a href="?page=products">Товары</a>
            
            <?php if (!$currentUser): ?>
                <a href="?page=login">Вход</a>
                <a href="?page=register">Регистрация</a>
            <?php else: ?>
                <a href="?page=profile">Профиль</a>
                <a href="?page=orders">Мои заказы</a>
                <?php if ($currentUser->getUsername() === 'admin'): ?>
                    <a href="?page=admin">Админ-панель</a>
                    <a href="?page=statistics">Статистика</a>
                <?php endif; ?>
                <a href="?page=logout" onclick="return confirm('Вы уверены что хотите выйти?')">Выход</a>
            <?php endif; ?>
            
            <?php if ($currentUser): ?>
                <form method="post" action="" style="display: inline;">
                    <input type="hidden" name="action" value="search">
                    <input type="search" name="query" placeholder="Поиск товаров..." 
                           value="<?= htmlspecialchars($searchQuery ?? '') ?>">
                </form>
            <?php endif; ?>
        </div>
        
        <div class="main">
            <?php displayMessages(); ?>
            
            <?php
            switch ($page) {
                case 'home':
                    include 'views/home.php';
                    break;
                case 'login':
                    include 'views/login.php';
                    break;
                case 'register':
                    include 'views/register.php';
                    break;
                case 'profile':
                    include 'views/profile.php';
                    break;
                case 'products':
                    include 'views/products.php';
                    break;
                case 'orders':
                    include 'views/orders.php';
                    break;
                case 'admin':
                    include 'views/admin.php';
                    break;
                case 'statistics':
                    include 'views/statistics.php';
                    break;
                case 'logout':
                    User::logout();
                    header('Location: ?page=home');
                    exit;
                default:
                    include 'views/home.php';
            }
            ?>
        </div>
        
        <div class="footer">
            <p>&copy; <?= date('Y') ?> <?= APP_NAME ?>. Все права защищены.</p>
            <p>Время выполнения: <?= round(microtime(true) - $_SERVER['REQUEST_TIME_FLOAT'], 4) ?> сек</p>
            <p>Использовано памяти: <?= round(memory_get_peak_usage(true) / 1024 / 1024, 2) ?> MB</p>
        </div>
    </div>
    
    <?= $js ?>
</body>
</html>
<?php

// Создаем представления (views)
ob_start();

// View: Главная страница
?>
<div class="card">
    <h2>Добро пожаловать в систему управления пользователями!</h2>
    <p>Эта система демонстрирует возможности PHP для создания полноценного веб-приложения с:</p>
    <ul style="margin: 15px 0; padding-left: 20px;">
        <li>Регистрацией и аутентификацией пользователей</li>
        <li>Управлением профилями</li>
        <li>Каталогом товаров с категориями</li>
        <li>Системой заказов</li>
        <li>Административной панелью</li>
        <li>Статистикой и аналитикой</li>
    </ul>
    
    <?php if (!$currentUser): ?>
        <div style="text-align: center; margin: 30px 0;">
            <p>Для начала работы войдите в систему или зарегистрируйтесь</p>
            <a href="?page=login" class="btn" style="margin: 10px;">Войти</a>
            <a href="?page=register" class="btn" style="margin: 10px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">Регистрация</a>
        </div>
    <?php else: ?>
        <div style="text-align: center; margin: 30px 0;">
            <p>Вы вошли как <strong><?= htmlspecialchars($currentUser->getUsername()) ?></strong></p>
            <p>Email: <?= htmlspecialchars($currentUser->getEmail()) ?></p>
            <?php if ($currentUser->getFullName()): ?>
                <p>Полное имя: <?= htmlspecialchars($currentUser->getFullName()) ?></p>
            <?php endif; ?>
            <?php if ($currentUser->getBirthDate()): ?>
                <p>Дата рождения: <?= formatDate($currentUser->getBirthDate()) ?></p>
            <?php endif; ?>
            <?php if ($age = $currentUser->getAge()): ?>
                <p>Возраст: <?= $age ?> лет</p>
            <?php endif; ?>
            <p>Дата регистрации: <?= formatDate($currentUser->getCreatedAt()) ?></p>
            <?php if ($currentUser->getLastLogin()): ?>
                <p>Последний вход: <?= formatDate($currentUser->getLastLogin()) ?></p>
            <?php endif; ?>
            
            <div style="margin-top: 20px;">
                <a href="?page=products" class="btn">Перейти к товарам</a>
                <a href="?page=profile" class="btn" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">Редактировать профиль</a>
            </div>
        </div>
    <?php endif; ?>
    
    <div class="stats-grid">
        <div class="stat-card">
            <h3>Пользователи</h3>
            <div class="stat-value"><?= count(User::getAllUsers(1000)) ?></div>
            <p>зарегистрировано в системе</p>
        </div>
        <div class="stat-card">
            <h3>Товары</h3>
            <div class="stat-value"><?= count(Product::getAllProducts(null, 1000)) ?></div>
            <p>в каталоге</p>
        </div>
        <div class="stat-card">
            <h3>Заказы</h3>
            <div class="stat-value"><?= count(Order::getAllOrders(1000)) ?></div>
            <p>обработано системой</p>
        </div>
    </div>
</div>
<?php
$views['home'] = ob_get_clean();

// View: Вход
ob_start();
?>
<div class="card">
    <h2>Вход в систему</h2>
    <form method="post" action="">
        <input type="hidden" name="action" value="login">
        
        <div class="form-group">
            <label for="username">Имя пользователя или Email:</label>
            <input type="text" id="username" name="username" required 
                   value="<?= htmlspecialchars($_POST['username'] ?? '') ?>">
        </div>
        
        <div class="form-group">
            <label for="password">Пароль:</label>
            <input type="password" id="password" name="password" required>
        </div>
        
        <div class="form-group">
            <button type="submit" class="btn">Войти</button>
            <a href="?page=register" style="margin-left: 20px;">Нет аккаунта? Зарегистрируйтесь</a>
        </div>
    </form>
    
    <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
        <h3>Тестовые аккаунты:</h3>
        <table class="table">
            <tr>
                <th>Логин</th>
                <th>Пароль</th>
                <th>Роль</th>
            </tr>
            <tr>
                <td>admin</td>
                <td>admin123</td>
                <td>Администратор</td>
            </tr>
            <tr>
                <td>user1</td>
                <td>user123</td>
                <td>Пользователь</td>
            </tr>
            <tr>
                <td>user2</td>
                <td>user123</td>
                <td>Пользователь</td>
            </tr>
        </table>
    </div>
</div>
<?php
$views['login'] = ob_get_clean();

// View: Регистрация
ob_start();
?>
<div class="card">
    <h2>Регистрация нового пользователя</h2>
    <form method="post" action="">
        <input type="hidden" name="action" value="register">
        
        <div class="form-group">
            <label for="reg_username">Имя пользователя:*</label>
            <input type="text" id="reg_username" name="username" required 
                   value="<?= htmlspecialchars($_POST['username'] ?? '') ?>">
            <small>От 3 до 50 символов, только буквы, цифры и подчеркивания</small>
        </div>
        
        <div class="form-group">
            <label for="reg_email">Email:*</label>
            <input type="email" id="reg_email" name="email" required 
                   value="<?= htmlspecialchars($_POST['email'] ?? '') ?>">
        </div>
        
        <div class="form-group">
            <label for="reg_password">Пароль:*</label>
            <input type="password" id="reg_password" name="password" required>
            <small>Минимум 8 символов</small>
        </div>
        
        <div class="form-group">
            <label for="reg_full_name">Полное имя:</label>
            <input type="text" id="reg_full_name" name="full_name" 
                   value="<?= htmlspecialchars($_POST['full_name'] ?? '') ?>">
        </div>
        
        <div class="form-group">
            <label for="reg_birth_date">Дата рождения:</label>
            <input type="date" id="reg_birth_date" name="birth_date" 
                   value="<?= htmlspecialchars($_POST['birth_date'] ?? '') ?>">
        </div>
        
        <div class="form-group">
            <button type="submit" class="btn">Зарегистрироваться</button>
            <a href="?page=login" style="margin-left: 20px;">Уже есть аккаунт? Войдите</a>
        </div>
    </form>
</div>
<?php
$views['register'] = ob_get_clean();

// View: Профиль
ob_start();
if (!$currentUser): ?>
    <div class="card">
        <h2>Доступ запрещен</h2>
        <p>Для просмотра профиля необходимо войти в систему.</p>
        <a href="?page=login" class="btn">Войти</a>
    </div>
<?php else: ?>
    <div class="card">
        <h2>Редактирование профиля</h2>
        <form method="post" action="">
            <input type="hidden" name="action" value="update_profile">
            
            <div class="form-group">
                <label>Имя пользователя:</label>
                <input type="text" value="<?= htmlspecialchars($currentUser->getUsername()) ?>" disabled>
                <small>Имя пользователя нельзя изменить</small>
            </div>
            
            <div class="form-group">
                <label>Email:</label>
                <input type="text" value="<?= htmlspecialchars($currentUser->getEmail()) ?>" disabled>
            </div>
            
            <div class="form-group">
                <label for="profile_full_name">Полное имя:</label>
                <input type="text" id="profile_full_name" name="full_name" 
                       value="<?= htmlspecialchars($currentUser->getFullName() ?? '') ?>">
            </div>
            
            <div class="form-group">
                <label for="profile_birth_date">Дата рождения:</label>
                <input type="date" id="profile_birth_date" name="birth_date" 
                       value="<?= htmlspecialchars($currentUser->getBirthDate() ?? '') ?>">
            </div>
            
            <div class="form-group">
                <label for="profile_password">Новый пароль:</label>
                <input type="password" id="profile_password" name="password">
                <small>Оставьте пустым, если не хотите менять пароль</small>
            </div>
            
            <div class="form-group">
                <button type="submit" class="btn">Сохранить изменения</button>
            </div>
        </form>
        
        <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
            <h3>Информация о профиле:</h3>
            <table class="table">
                <tr>
                    <td>Дата регистрации:</td>
                    <td><strong><?= formatDate($currentUser->getCreatedAt()) ?></strong></td>
                </tr>
                <tr>
                    <td>Последний вход:</td>
                    <td><strong><?= formatDate($currentUser->getLastLogin()) ?></strong></td>
                </tr>
                <tr>
                    <td>Возраст:</td>
                    <td><strong><?= $currentUser->getAge() ?? 'Не указан' ?> лет</strong></td>
                </tr>
                <tr>
                    <td>Статус:</td>
                    <td><strong style="color: green;">Активен</strong></td>
                </tr>
            </table>
        </div>
    </div>
<?php endif;
$views['profile'] = ob_get_clean();

// View: Товары
ob_start();
$categories = Product::getCategories();
$selectedCategory = $_GET['category'] ?? null;
$products = $searchQuery ? Product::searchProducts($searchQuery) : Product::getAllProducts($selectedCategory);
?>
<div class="card">
    <h2>Каталог товаров <?= $searchQuery ? 'по запросу: "' . htmlspecialchars($searchQuery) . '"' : '' ?></h2>
    
    <div style="margin: 20px 0;">
        <form method="get" action="" style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <select name="category" onchange="this.form.submit()">
                <option value="">Все категории</option>
                <?php foreach ($categories as $cat): ?>
                    <option value="<?= htmlspecialchars($cat) ?>" <?= $selectedCategory == $cat ? 'selected' : '' ?>>
                        <?= htmlspecialchars($cat) ?>
                    </option>
                <?php endforeach; ?>
            </select>
            
            <a href="?page=products" class="btn">Сбросить фильтры</a>
            
            <?php if ($currentUser && $currentUser->getUsername() === 'admin'): ?>
                <a href="#add-product" class="btn" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">Добавить товар</a>
            <?php endif; ?>
        </form>
    </div>
    
    <?php if (empty($products)): ?>
        <div style="text-align: center; padding: 40px;">
            <h3>Товары не найдены</h3>
            <p>Попробуйте изменить критерии поиска</p>
        </div>
    <?php else: ?>
        <div class="product-grid">
            <?php foreach ($products as $product): ?>
                <div class="product-card">
                    <div class="product-image">
                        <?= substr($product['name'], 0, 1) ?>
                    </div>
                    <div class="product-info">
                        <h3><?= htmlspecialchars($product['name']) ?></h3>
                        <p><?= htmlspecialchars(substr($product['description'], 0, 100)) ?>...</p>
                        <div class="product-price"><?= formatPrice($product['price']) ?></div>
                        <p><strong>Категория:</strong> <?= htmlspecialchars($product['category'] ?? 'Без категории') ?></p>
                        <p><strong>На складе:</strong> <?= $product['stock'] ?> шт.</p>
                        <p><small>Добавлен: <?= formatDate($product['created_at']) ?></small></p>
                        
                        <?php if ($currentUser): ?>
                            <div style="margin-top: 15px;">
                                <button class="btn" onclick="addToCart(<?= $product['id'] ?>, '<?= htmlspecialchars($product['name']) ?>', <?= $product['price'] ?>)">
                                    В корзину
                                </button>
                            </div>
                        <?php endif; ?>
                    </div>
                </div>
            <?php endforeach; ?>
        </div>
        
        <div style="text-align: center; margin-top: 30px;">
            <p>Показано <?= count($products) ?> товаров</p>
        </div>
    <?php endif; ?>
</div>

<?php if ($currentUser && $currentUser->getUsername() === 'admin'): ?>
    <div class="card" id="add-product">
        <h2>Добавить новый товар</h2>
        <form method="post" action="">
            <input type="hidden" name="action" value="add_product">
            
            <div class="form-group">
                <label for="product_name">Название товара:*</label>
                <input type="text" id="product_name" name="name" required>
            </div>
            
            <div class="form-group">
                <label for="product_description">Описание:</label>
                <textarea id="product_description" name="description" rows="3"></textarea>
            </div>
            
            <div class="form-group">
                <label for="product_price">Цена:*</label>
                <input type="number" id="product_price" name="price" step="0.01" min="0" required>
            </div>
            
            <div class="form-group">
                <label for="product_category">Категория:</label>
                <select id="product_category" name="category">
                    <option value="">Выберите категорию</option>
                    <?php foreach ($categories as $cat): ?>
                        <option value="<?= htmlspecialchars($cat) ?>"><?= htmlspecialchars($cat) ?></option>
                    <?php endforeach; ?>
                    <option value="new">Новая категория...</option>
                </select>
                <input type="text" id="new_category" name="new_category" style="display: none; margin-top: 5px;" placeholder="Введите новую категорию">
            </div>
            
            <div class="form-group">
                <label for="product_stock">Количество на складе:</label>
                <input type="number" id="product_stock" name="stock" min="0" value="0">
            </div>
            
            <div class="form-group">
                <button type="submit" class="btn">Добавить товар</button>
            </div>
        </form>
    </div>
    
    <script>
        document.getElementById('product_category').addEventListener('change', function() {
            const newCategoryInput = document.getElementById('new_category');
            newCategoryInput.style.display = this.value === 'new' ? 'block' : 'none';
            if (this.value !== 'new') {
                newCategoryInput.value = '';
            }
        });
    </script>
<?php endif; ?>

<script>
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    
    function addToCart(productId, productName, price) {
        const existingItem = cart.find(item => item.id === productId);
        
        if (existingItem) {
            existingItem.quantity += 1;
        } else {
            cart.push({
                id: productId,
                name: productName,
                price: price,
                quantity: 1
            });
        }
        
        localStorage.setItem('cart', JSON.stringify(cart));
        alert('Товар "' + productName + '" добавлен в корзину!');
        updateCartCount();
    }
    
    function updateCartCount() {
        const count = cart.reduce((total, item) => total + item.quantity, 0);
        const cartBadge = document.getElementById('cart-count');
        if (cartBadge) {
            cartBadge.textContent = count;
        }
    }
    
    function showCart() {
        if (cart.length === 0) {
            alert('Корзина пуста');
            return;
        }
        
        let message = 'Ваша корзина:\n\n';
        let total = 0;
        
        cart.forEach(item => {
            const itemTotal = item.price * item.quantity;
            total += itemTotal;
            message += `${item.name} x ${item.quantity} = ${itemTotal.toFixed(2)} руб.\n`;
        });
        
        message += `\nИтого: ${total.toFixed(2)} руб.\n\nОформить заказ?`;
        
        if (confirm(message)) {
            createOrder();
        }
    }
    
    function createOrder() {
        const items = cart.map(item => ({
            product_id: item.id,
            quantity: item.quantity
        }));
        
        const form = document.createElement('form');
        form.method = 'POST';
        form.style.display = 'none';
        
        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'action';
        actionInput.value = 'create_order';
        form.appendChild(actionInput);
        
        const itemsInput = document.createElement('input');
        itemsInput.type = 'hidden';
        itemsInput.name = 'items';
        itemsInput.value = JSON.stringify(items);
        form.appendChild(itemsInput);
        
        document.body.appendChild(form);
        form.submit();
    }
    
    // Обновляем счетчик корзины при загрузке
    document.addEventListener('DOMContentLoaded', updateCartCount);
</script>

<div style="position: fixed; bottom: 30px; right: 30px;">
    <button class="btn" onclick="showCart()" style="padding: 15px 25px; border-radius: 50px; font-size: 18px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
        🛒 Корзина (<span id="cart-count">0</span>)
    </button>
</div>
<?php
$views['products'] = ob_get_clean();

// View: Заказы
ob_start();
if (!$currentUser): ?>
    <div class="card">
        <h2>Доступ запрещен</h2>
        <p>Для просмотра заказов необходимо войти в систему.</p>
        <a href="?page=login" class="btn">Войти</a>
    </div>
<?php else:
    $orders = $currentUser->getUsername() === 'admin' ? Order::getAllOrders() : Order::getUserOrders($currentUser->getId());
?>
    <div class="card">
        <h2><?= $currentUser->getUsername() === 'admin' ? 'Все заказы' : 'Мои заказы' ?></h2>
        
        <?php if (empty($orders)): ?>
            <div style="text-align: center; padding: 40px;">
                <h3>Заказы не найдены</h3>
                <p>У вас пока нет заказов</p>
                <a href="?page=products" class="btn">Перейти к товарам</a>
            </div>
        <?php else: ?>
            <table class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <?php if ($currentUser->getUsername() === 'admin'): ?>
                            <th>Пользователь</th>
                        <?php endif; ?>
                        <th>Сумма</th>
                        <th>Статус</th>
                        <th>Дата создания</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($orders as $order): ?>
                        <tr>
                            <td>#<?= $order['id'] ?></td>
                            <?php if ($currentUser->getUsername() === 'admin'): ?>
                                <td><?= htmlspecialchars($order['username'] ?? 'Гость') ?></td>
                            <?php endif; ?>
                            <td><?= formatPrice($order['total_amount']) ?></td>
                            <td>
                                <span style="
                                    padding: 5px 10px;
                                    border-radius: 15px;
                                    font-size: 12px;
                                    background: <?= 
                                        $order['status'] === 'completed' ? '#d4edda' : 
                                        ($order['status'] === 'processing' ? '#fff3cd' : '#f8d7da') 
                                    ?>;
                                    color: <?= 
                                        $order['status'] === 'completed' ? '#155724' : 
                                        ($order['status'] === 'processing' ? '#856404' : '#721c24') 
                                    ?>;
                                ">
                                    <?= htmlspecialchars($order['status']) ?>
                                </span>
                            </td>
                            <td><?= formatDate($order['created_at']) ?></td>
                            <td>
                                <?php if ($currentUser->getUsername() === 'admin'): ?>
                                    <form method="post" action="" style="display: inline;">
                                        <input type="hidden" name="action" value="update_order_status">
                                        <input type="hidden" name="order_id" value="<?= $order['id'] ?>">
                                        <select name="status" onchange="this.form.submit()" style="padding: 5px; font-size: 14px;">
                                            <option value="pending" <?= $order['status'] === 'pending' ? 'selected' : '' ?>>Ожидает</option>
                                            <option value="processing" <?= $order['status'] === 'processing' ? 'selected' : '' ?>>В обработке</option>
                                            <option value="completed" <?= $order['status'] === 'completed' ? 'selected' : '' ?>>Завершен</option>
                                            <option value="cancelled" <?= $order['status'] === 'cancelled' ? 'selected' : '' ?>>Отменен</option>
                                        </select>
                                    </form>
                                <?php else: ?>
                                    <button class="btn" style="padding: 5px 10px; font-size: 14px;">Подробнее</button>
                                <?php endif; ?>
                            </td>
                        </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
            
            <div style="text-align: center; margin-top: 20px;">
                <p>Показано <?= count($orders) ?> заказов</p>
            </div>
        <?php endif; ?>
    </div>
<?php endif;
$views['orders'] = ob_get_clean();

// View: Админ-панель
ob_start();
if (!$currentUser || $currentUser->getUsername() !== 'admin'): ?>
    <div class="card">
        <h2>Доступ запрещен</h2>
        <p>Эта страница доступна только администраторам.</p>
        <a href="?page=login" class="btn">Войти как администратор</a>
    </div>
<?php else:
    $users = User::getAllUsers();
    $products = Product::getAllProducts();
    $orders = Order::getAllOrders();
?>
    <div class="card">
        <h2>Административная панель</h2>
        <p>Добро пожаловать, администратор! Здесь вы можете управлять системой.</p>
        
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Пользователи</h3>
                <div class="stat-value"><?= count($users) ?></div>
                <a href="#users" style="color: white; text-decoration: underline;">Просмотреть всех</a>
            </div>
            <div class="stat-card">
                <h3>Товары</h3>
                <div class="stat-value"><?= count($products) ?></div>
                <a href="#products" style="color: white; text-decoration: underline;">Управление товарами</a>
            </div>
            <div class="stat-card">
                <h3>Заказы</h3>
                <div class="stat-value"><?= count($orders) ?></div>
                <a href="#orders" style="color: white; text-decoration: underline;">Управление заказами</a>
            </div>
        </div>
    </div>
    
    <div class="card" id="users">
        <h3>Управление пользователями</h3>
        
        <table class="table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Имя пользователя</th>
                    <th>Email</th>
                    <th>Полное имя</th>
                    <th>Дата рождения</th>
                    <th>Дата регистрации</th>
                    <th>Последний вход</th>
                    <th>Статус</th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($users as $user): ?>
                    <tr>
                        <td><?= $user['id'] ?></td>
                        <td><?= htmlspecialchars($user['username']) ?></td>
                        <td><?= htmlspecialchars($user['email']) ?></td>
                        <td><?= htmlspecialchars($user['full_name'] ?? 'Не указано') ?></td>
                        <td><?= $user['birth_date'] ? formatDate($user['birth_date']) : 'Не указано' ?></td>
                        <td><?= formatDate($user['created_at']) ?></td>
                        <td><?= $user['last_login'] ? formatDate($user['last_login']) : 'Никогда' ?></td>
                        <td>
                            <span style="color: <?= $user['is_active'] ? 'green' : 'red' ?>;">
                                <?= $user['is_active'] ? 'Активен' : 'Не активен' ?>
                            </span>
                        </td>
                    </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
        
        <div style="margin-top: 20px;">
            <a href="#" class="btn" onclick="exportUsers()">Экспорт в CSV</a>
        </div>
        
        <script>
            function exportUsers() {
                window.location.href = 'export.php?type=users';
            }
        </script>
    </div>
    
    <div class="card" id="products">
        <h3>Управление товарами</h3>
        
        <table class="table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Название</th>
                    <th>Цена</th>
                    <th>Категория</th>
                    <th>На складе</th>
                    <th>Дата добавления</th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($products as $product): ?>
                    <tr>
                        <td><?= $product['id'] ?></td>
                        <td><?= htmlspecialchars($product['name']) ?></td>
                        <td><?= formatPrice($product['price']) ?></td>
                        <td><?= htmlspecialchars($product['category'] ?? 'Без категории') ?></td>
                        <td><?= $product['stock'] ?></td>
                        <td><?= formatDate($product['created_at']) ?></td>
                    </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
    </div>
    
    <div class="card" id="orders">
        <h3>Управление заказами</h3>
        
        <table class="table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Пользователь</th>
                    <th>Сумма</th>
                    <th>Статус</th>
                    <th>Дата создания</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($orders as $order): ?>
                    <tr>
                        <td>#<?= $order['id'] ?></td>
                        <td><?= htmlspecialchars($order['username'] ?? 'Гость') ?></td>
                        <td><?= formatPrice($order['total_amount']) ?></td>
                        <td>
                            <form method="post" action="" style="display: inline;">
                                <input type="hidden" name="action" value="update_order_status">
                                <input type="hidden" name="order_id" value="<?= $order['id'] ?>">
                                <select name="status" onchange="this.form.submit()" style="padding: 5px; font-size: 14px;">
                                    <option value="pending" <?= $order['status'] === 'pending' ? 'selected' : '' ?>>Ожидает</option>
                                    <option value="processing" <?= $order['status'] === 'processing' ? 'selected' : '' ?>>В обработке</option>
                                    <option value="completed" <?= $order['status'] === 'completed' ? 'selected' : '' ?>>Завершен</option>
                                    <option value="cancelled" <?= $order['status'] === 'cancelled' ? 'selected' : '' ?>>Отменен</option>
                                </select>
                            </form>
                        </td>
                        <td><?= formatDate($order['created_at']) ?></td>
                        <td>
                            <button class="btn" style="padding: 5px 10px; font-size: 14px;">Подробнее</button>
                        </td>
                    </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
    </div>
    
    <div class="card">
        <h3>Системные действия</h3>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="btn" onclick="backupDatabase()">Создать резервную копию БД</button>
            <button class="btn" onclick="clearCache()">Очистить кэш</button>
            <button class="btn" onclick="generateReport()">Сгенерировать отчет</button>
        </div>
    </div>
    
    <script>
        function backupDatabase() {
            if (confirm('Создать резервную копию базы данных?')) {
                alert('Резервная копия создана!');
            }
        }
        
        function clearCache() {
            if (confirm('Очистить системный кэш?')) {
                alert('Кэш очищен!');
            }
        }
        
        function generateReport() {
            alert('Отчет сгенерирован и отправлен на email администратора!');
        }
    </script>
<?php endif;
$views['admin'] = ob_get_clean();

// View: Статистика
ob_start();
if (!$currentUser || $currentUser->getUsername() !== 'admin'): ?>
    <div class="card">
        <h2>Доступ запрещен</h2>
        <p>Эта страница доступна только администраторам.</p>
        <a href="?page=login" class="btn">Войти как администратор</a>
    </div>
<?php else:
    $stats = Statistics::getDashboardStats();
    $activity = Statistics::getRecentActivity();
?>
    <div class="card">
        <h2>Статистика системы</h2>
        <p>Общая информация о работе системы</p>
        
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Пользователи</h3>
                <div class="stat-value"><?= $stats['total_users'] ?></div>
                <p><?= $stats['active_users'] ?> активных</p>
            </div>
            <div class="stat-card">
                <h3>Товары</h3>
                <div class="stat-value"><?= $stats['total_products'] ?></div>
                <p><?= $stats['total_stock'] ?> на складе</p>
            </div>
            <div class="stat-card">
                <h3>Заказы</h3>
                <div class="stat-value"><?= $stats['total_orders'] ?></div>
                <p><?= number_format($stats['total_revenue'], 2) ?> руб. выручки</p>
            </div>
            <div class="stat-card">
                <h3>Новые пользователи</h3>
                <div class="stat-value"><?= $stats['new_users_7_days'] ?></div>
                <p>за последние 7 дней</p>
            </div>
        </div>
    </div>
    
    <div class="card">
        <h3>Заказы по статусам</h3>
        <table class="table">
            <thead>
                <tr>
                    <th>Статус</th>
                    <th>Количество</th>
                    <th>Процент</th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($stats['orders_by_status'] as $status): ?>
                    <tr>
                        <td><?= htmlspecialchars($status['status']) ?></td>
                        <td><?= $status['count'] ?></td>
                        <td><?= $stats['total_orders'] > 0 ? round($status['count'] / $stats['total_orders'] * 100, 1) : 0 ?>%</td>
                    </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
    </div>
    
    <div class="card">
        <h3>Товары по категориям</h3>
        <table class="table">
            <thead>
                <tr>
                    <th>Категория</th>
                    <th>Количество товаров</th>
                    <th>Всего на складе</th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($stats['products_by_category'] as $category): ?>
                    <tr>
                        <td><?= htmlspecialchars($category['category']) ?></td>
                        <td><?= $category['count'] ?></td>
                        <td><?= $category['stock'] ?></td>
                    </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
    </div>
    
    <div class="card">
        <h3>Последние заказы</h3>
        <table class="table">
            <thead>
                <tr>
                    <th>ID заказа</th>
                    <th>Пользователь</th>
                    <th>Сумма</th>
                    <th>Статус</th>
                    <th>Дата</th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($activity['recent_orders'] as $order): ?>
                    <tr>
                        <td>#<?= $order['id'] ?></td>
                        <td><?= htmlspecialchars($order['username'] ?? 'Гость') ?></td>
                        <td><?= formatPrice($order['total_amount']) ?></td>
                        <td><?= htmlspecialchars($order['status']) ?></td>
                        <td><?= formatDate($order['created_at']) ?></td>
                    </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
    </div>
    
    <div class="card">
        <h3>Последние пользователи</h3>
        <table class="table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Имя пользователя</th>
                    <th>Email</th>
                    <th>Дата регистрации</th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($activity['recent_users'] as $user): ?>
                    <tr>
                        <td><?= $user['id'] ?></td>
                        <td><?= htmlspecialchars($user['username']) ?></td>
                        <td><?= htmlspecialchars($user['email']) ?></td>
                        <td><?= formatDate($user['created_at']) ?></td>
                    </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
    </div>
    
    <div class="card">
        <h3>Графики и аналитика</h3>
        <div style="text-align: center; padding: 30px;">
            <p style="color: #666; font-style: italic;">
                Здесь могут отображаться графики активности, диаграммы продаж 
                и другая аналитическая информация
            </p>
            <div style="display: flex; justify-content: center; gap: 20px; margin-top: 20px;">
                <button class="btn" onclick="showSalesChart()">График продаж</button>
                <button class="btn" onclick="showUserActivity()">Активность пользователей</button>
                <button class="btn" onclick="exportStatistics()">Экспорт статистики</button>
            </div>
        </div>
    </div>
    
    <script>
        function showSalesChart() {
            alert('График продаж загружается...');
            // Здесь можно добавить реальный график с использованием Chart.js или другой библиотеки
        }
        
        function showUserActivity() {
            alert('График активности пользователей загружается...');
        }
        
        function exportStatistics() {
            if (confirm('Экспортировать статистику в CSV файл?')) {
                window.location.href = 'export.php?type=statistics';
            }
        }
    </script>
<?php endif;
$views['statistics'] = ob_get_clean();

// Вставляем выбранное представление
echo $views[$page] ?? $views['home'];

// Выводим результат
ob_end_flush();